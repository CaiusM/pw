var npcs = [["Kon Leron", "Snowy Village", "Amethyst Village", "Hidden Heroes Village", "Arrowhead Manor", "Sundown Town", "Village of the Brutes", "Dreaming Cloud", "Sumor Camp", "Swiftwind Tribe", "Battlemark Village", "Orchid Temple", "Town of Arrivals", "Dreaming Stronghold", "Tradewind", "Village of the Lost", "Ancestral Shrine", "Ancient Wall", "Sandsong Village", "Cromagnon Village", "Shrine of Immortals", "Forgotten Sanctuary", "Silver Pool", "Wellspring Village", "Allies Camp", "North Barrier Village", "Dragon's End", "Bleakhaven Ruins", "King's Feast", "Bamboo Village", "Hunter Cabin", "Broken Bridge", "Altar of Dreams", "Village of Naught", "Hidden Orchid", "South Barrier Village", "Avalanche Village", "Dragonfang Village", "Tusk Town", "Intrepid Camp", "Nightfire Altar", "Angler's Village", "Immolation Camp", "Camp Wave Breaker", "East Barrier Village", "Shattered Ice", "Walled Stronghold", "Sirry Wine Camp", "Gate of Antiquity", "Nameless Isle", "Timberfield", "Sanctuary", "Whetstone Keep"],
["Shon Saiven", "Allies Camp", "Dreaming Stronghold", "Battlemark Village", "Bamboo Village", "Town of Arrivals", "Ancestral Shrine", "Hunter Cabin", "Silver Pool", "Orchid Temple", "Sandsong Village", "Dragon's End", "Swiftwind Tribe", "Broken Bridge", "Village of the Brutes", "Snowy Village", "Hidden Orchid", "East Barrier Village", "Avalanche Village", "Dreaming Cloud", "North Barrier Village", "Sundown Town", "Tradewind", "Dragonfang Village", "Village of Naught", "Forgotten Sanctuary", "King's Feast", "Ancient Wall", "Bleakhaven Ruins", "Wellspring Village", "Sirry Wine Camp", "Shattered Ice", "Village of the Lost", "South Barrier Village", "Arrowhead Manor", "Hidden Heroes Village", "Sumor Camp", "Cromagnon Village", "Angler's Village", "Amethyst Village", "Immolation Camp", "Gate of Antiquity", "Shrine of Immortals", "Sanctuary", "Altar of Dreams", "Camp Wave Breaker", "Timberfield", "Intrepid Camp", "Whetstone Keep", "Nightfire Altar", "Nameless Isle", "Tusk Town", "Walled Stronghold"],
["Tsen Wankay", "Village of the Lost", "Intrepid Camp", "South Barrier Village", "Hidden Orchid", "Forgotten Sanctuary", "Tradewind", "Cromagnon Village", "Avalanche Village", "Town of Arrivals", "Hidden Heroes Village", "Swiftwind Tribe", "Sundown Town", "Amethyst Village", "Silver Pool", "Altar of Dreams", "Village of the Brutes", "Bleakhaven Ruins", "Battlemark Village", "Dragonfang Village", "Immolation Camp", "North Barrier Village", "Sumor Camp", "Bamboo Village", "Snowy Village", "Shrine of Immortals", "Orchid Temple", "King's Feast", "Dragon's End", "Arrowhead Manor", "Dreaming Cloud", "Dreaming Stronghold", "East Barrier Village", "Allies Camp", "Ancestral Shrine", "Village of Naught", "Sandsong Village", "Wellspring Village", "Sanctuary", "Sirry Wine Camp", "Nameless Isle", "Tusk Town", "Nightfire Altar", "Shattered Ice", "Ancient Wall", "Broken Bridge", "Whetstone Keep", "Hunter Cabin", "Angler's Village", "Timberfield", "Walled Stronghold", "Camp Wave Breaker", "Gate of Antiquity"],
["Sonn Katson", "East Barrier Village", "Hunter Cabin", "Allies Camp", "Village of the Brutes", "Shrine of Immortals", "Sumor Camp", "Wellspring Village", "Battlemark Village", "Forgotten Sanctuary", "Village of Naught", "Sundown Town", "North Barrier Village", "Sirry Wine Camp", "Avalanche Village", "Ancient Wall", "Silver Pool", "Dragon's End", "South Barrier Village", "Bamboo Village", "Nameless Isle", "Immolation Camp", "Sandsong Village", "Hidden Orchid", "Altar of Dreams", "Nightfire Altar", "Town of Arrivals", "Orchid Temple", "Swiftwind Tribe", "Ancestral Shrine", "Dragonfang Village", "Intrepid Camp", "Bleakhaven Ruins", "Village of the Lost", "Tradewind", "Snowy Village", "Hidden Heroes Village", "Arrowhead Manor", "Shattered Ice", "Dreaming Cloud", "Walled Stronghold", "Camp Wave Breaker", "Timberfield", "Dreaming Stronghold", "King's Feast", "Amethyst Village", "Angler's Village", "Cromagnon Village", "Sanctuary", "Whetstone Keep", "Gate of Antiquity", "Broken Bridge", "Tusk Town"],
["Geon Nenya", "Ancient Wall", "Dreaming Cloud", "Snowy Village", "Tradewind", "Immolation Camp", "Avalanche Village", "Bamboo Village", "Hidden Heroes Village", "North Barrier Village", "Allies Camp", "Forgotten Sanctuary", "Shrine of Immortals", "Hunter Cabin", "Sandsong Village", "Bleakhaven Ruins", "Sumor Camp", "Orchid Temple", "Village of Naught", "Arrowhead Manor", "Timberfield", "Nightfire Altar", "Battlemark Village", "Ancestral Shrine", "East Barrier Village", "Nameless Isle", "Sundown Town", "Swiftwind Tribe", "Town of Arrivals", "Village of the Brutes", "Wellspring Village", "Sirry Wine Camp", "King's Feast", "Altar of Dreams", "Silver Pool", "Village of the Lost", "South Barrier Village", "Hidden Orchid", "Broken Bridge", "Cromagnon Village", "Whetstone Keep", "Shattered Ice", "Walled Stronghold", "Amethyst Village", "Dragon's End", "Intrepid Camp", "Tusk Town", "Dragonfang Village", "Camp Wave Breaker", "Gate of Antiquity", "Angler's Village", "Dreaming Stronghold", "Sanctuary"],
["Fox Child", "Swiftwind Tribe", "Arrowhead Manor", "Bleakhaven Ruins", "Battlemark Village", "Whetstone Keep", "Village of Naught", "Tradewind", "Village of the Lost", "Timberfield", "Ancient Wall", "Nameless Isle", "Walled Stronghold", "Bamboo Village", "Allies Camp", "Town of Arrivals", "South Barrier Village", "North Barrier Village", "East Barrier Village", "Silver Pool", "Tusk Town", "Gate of Antiquity", "Snowy Village", "Avalanche Village", "Orchid Temple", "Angler's Village", "Nightfire Altar", "Shrine of Immortals", "Immolation Camp", "Sandsong Village", "Village of the Brutes", "Wellspring Village", "Sundown Town", "Dragon's End", "Hidden Heroes Village", "King's Feast", "Altar of Dreams", "Sumor Camp", "Hunter Cabin", "Hidden Orchid", "Camp Wave Breaker", "Sirry Wine Camp", "Sanctuary", "Cromagnon Village", "Forgotten Sanctuary", "Dragonfang Village", "Dreaming Stronghold", "Ancestral Shrine", "Intrepid Camp", "Shattered Ice", "Broken Bridge", "Dreaming Cloud", "Amethyst Village"],
["Jade Feline", "Altar of Dreams", "Sirry Wine Camp", "Village of Naught", "Ancestral Shrine", "North Barrier Village", "Silver Pool", "Dragonfang Village", "Sandsong Village", "Sundown Town", "South Barrier Village", "Town of Arrivals", "Forgotten Sanctuary", "Intrepid Camp", "Sumor Camp", "East Barrier Village", "Tradewind", "King's Feast", "Hidden Heroes Village", "Wellspring Village", "Nightfire Altar", "Shrine of Immortals", "Avalanche Village", "Arrowhead Manor", "Village of the Lost", "Immolation Camp", "Swiftwind Tribe", "Dragon's End", "Orchid Temple", "Hidden Orchid", "Cromagnon Village", "Amethyst Village", "Ancient Wall", "Snowy Village", "Village of the Brutes", "Allies Camp", "Battlemark Village", "Bamboo Village", "Camp Wave Breaker", "Hunter Cabin", "Timberfield", "Sanctuary", "Nameless Isle", "Broken Bridge", "Bleakhaven Ruins", "Dreaming Stronghold", "Gate of Antiquity", "Dreaming Cloud", "Tusk Town", "Walled Stronghold", "Whetstone Keep", "Shattered Ice", "Angler's Village"],
["Yon Tonsy", "Dragon's End", "Wellspring Village", "East Barrier Village", "Avalanche Village", "Timberfield", "Hidden Heroes Village", "Ancestral Shrine", "Allies Camp", "Nightfire Altar", "Altar of Dreams", "Immolation Camp", "Nameless Isle", "Dragonfang Village", "South Barrier Village", "Orchid Temple", "Battlemark Village", "Sundown Town", "Village of the Lost", "Village of the Brutes", "Gate of Antiquity", "Walled Stronghold", "Village of Naught", "Silver Pool", "King's Feast", "Whetstone Keep", "Shrine of Immortals", "Forgotten Sanctuary", "North Barrier Village", "Sumor Camp", "Hidden Orchid", "Cromagnon Village", "Swiftwind Tribe", "Bleakhaven Ruins", "Sandsong Village", "Ancient Wall", "Snowy Village", "Tradewind", "Intrepid Camp", "Bamboo Village", "Tusk Town", "Amethyst Village", "Angler's Village", "Hunter Cabin", "Town of Arrivals", "Dreaming Cloud", "Shattered Ice", "Arrowhead Manor", "Dreaming Stronghold", "Sanctuary", "Camp Wave Breaker", "Sirry Wine Camp", "Broken Bridge"],
["Leu Ninsi", "Town of Arrivals", "Hidden Orchid", "King's Feast", "Hidden Heroes Village", "Gate of Antiquity", "Allies Camp", "Silver Pool", "Altar of Dreams", "Walled Stronghold", "Bleakhaven Ruins", "Timberfield", "Whetstone Keep", "Arrowhead Manor", "Snowy Village", "Sundown Town", "Village of Naught", "Shrine of Immortals", "Ancient Wall", "Sumor Camp", "Sanctuary", "Angler's Village", "Village of the Lost", "Sandsong Village", "Whetstone Keep", "Tusk Town", "Nameless Isle", "Immolation Camp", "Nightfire Altar", "Amethyst Village", "Tradewind", "Bamboo Village", "Forgotten Sanctuary", "Orchid Temple", "South Barrier Village", "Dragon's End", "East Barrier Village", "Avalanche Village", "Dreaming Cloud", "Ancestral Shrine", "Shattered Ice", "Hunter Cabin", "Camp Wave Breaker", "Dragonfang Village", "North Barrier Village", "Wellspring Village", "Battlemark Village", "Village of the Brutes", "Sirry Wine Camp", "Broken Bridge", "Dreaming Stronghold", "Cromagnon Village", "Intrepid Camp"],
["Zuw Yonen", "Sundown Town", "Ancestral Shrine", "Dragon's End", "South Barrier Village", "Angler's Village", "Snowy Village", "Sumor Camp", "East Barrier Village", "Whetstone Keep", "King's Feast", "Walled Stronghold", "Gate of Antiquity", "Hidden Orchid", "Village of the Lost", "Forgotten Sanctuary", "Allies Camp", "Immolation Camp", "Bleakhaven Ruins", "Avalanche Village", "Camp Wave Breaker", "Tusk Town", "Altar of Dreams", "Battlemark Village", "Town of Arrivals", "Sanctuary", "Timberfield", "Nightfire Altar", "Nameless Isle", "Hidden Heroes Village", "Silver Pool", "Arrowhead Manor", "North Barrier Village", "Swiftwind Tribe", "Village of Naught", "Orchid Temple", "Ancient Wall", "Sandsong Village", "Cromagnon Village", "Village of the Brutes", "Broken Bridge", "Dreaming Cloud", "Shattered Ice", "Wellspring Village", "Shrine of Immortals", "Bamboo Village", "Intrepid Camp", "Tradewind", "Hunter Cabin", "Dreaming Stronghold", "Amethyst Village", "Dragonfang Village", "Sirry Wine Camp"],
["Vin Horlan", "King's Feast", "Dragonfang Village", "Altar of Dreams", "Sumor Camp", "Nameless Isle", "Battlemark Village", "Hidden Orchid", "Village of Naught", "Immolation Camp", "Village of the Lost", "Shrine of Immortals", "Nightfire Altar", "Cromagnon Village", "Hidden Heroes Village", "Dragon's End", "Sandsong Village", "Town of Arrivals", "Snowy Village", "Ancestral Shrine", "Whetstone Keep", "Timberfield", "South Barrier Village", "Tradewind", "Bleakhaven Ruins", "Walled Stronghold", "North Barrier Village", "Sundown Town", "Forgotten Sanctuary", "Silver Pool", "Arrowhead Manor", "Dreaming Cloud", "Orchid Temple", "Ancient Wall", "Avalanche Village", "East Barrier Village", "Allies Camp", "Village of the Brutes", "Amethyst Village", "Wellspring Village", "Angler's Village", "Dreaming Stronghold", "Gate of Antiquity", "Sirry Wine Camp", "Swiftwind Tribe", "Hunter Cabin", "Camp Wave Breaker", "Bamboo Village", "Broken Bridge", "Tusk Town", "Sanctuary", "Intrepid Camp", "Shattered Ice"],
["Wan Yirzin", "Orchid Temple", "Bamboo Village", "Ancient Wall", "Sandsong Village", "Walled Stronghold", "South Barrier Village", "Village of the Brutes", "Snowy Village", "Nameless Isle", "East Barrier Village", "Nightfire Altar", "Timberfield", "Wellspring Village", "Village of Naught", "Swiftwind Tribe", "Hidden Heroes Village", "Forgotten Sanctuary", "Altar of Dreams", "Tradewind", "Angler's Village", "Whetstone Keep", "Allies Camp", "Sumor Camp", "Dragon's End", "Gate of Antiquity", "Immolation Camp", "North Barrier Village", "Shrine of Immortals", "Avalanche Village", "Ancestral Shrine", "Dragonfang Village", "Town of Arrivals", "King's Feast", "Battlemark Village", "Bleakhaven Ruins", "Village of the Lost", "Silver Pool", "Sirry Wine Camp", "Arrowhead Manor", "Sanctuary", "Intrepid Camp", "Tusk Town", "Dreaming Cloud", "Sundown Town", "Cromagnon Village", "Broken Bridge", "Hidden Orchid", "Amethyst Village", "Camp Wave Breaker", "Shattered Ice", "Hunter Cabin", "Dreaming Stronghold"],
["Granny Sven", "Bleakhaven Ruins", "Cromagnon Village", "Village of the Lost", "Silver Pool", "Nightfire Altar", "Sandsong Village", "Arrowhead Manor", "South Barrier Village", "Shrine of Immortals", "Snowy Village", "North Barrier Village", "Immolation Camp", "Dreaming Cloud", "Battlemark Village", "King's Feast", "Avalanche Village", "Swiftwind Tribe", "Allies Camp", "Hidden Orchid", "Walled Stronghold", "Nameless Isle", "Hidden Heroes Village", "Village of the Brutes", "Ancient Wall", "Timberfield", "Forgotten Sanctuary", "Town of Arrivals", "Sundown Town", "Tradewind", "Bamboo Village", "Hunter Cabin", "Dragon's End", "East Barrier Village", "Sumor Camp", "Altar of Dreams", "Village of Naught", "Ancestral Shrine", "Dreaming Stronghold", "Dragonfang Village", "Gate of Antiquity", "Broken Bridge", "Whetstone Keep", "Intrepid Camp", "Orchid Temple", "Sirry Wine Camp", "Sanctuary", "Wellspring Village", "Shattered Ice", "Angler's Village", "Tusk Town", "Amethyst Village", "Camp Wave Breaker"]];
npcs.sort(function(a, b){ return a[0] > b[0]});

var token = '';
var otherNpcs = [["Dil Honse", "Rook's Valley", "Walled Stronghold", "Island of Broken Dreams"],
["Jan Holfen", "Dawnglory", "Farewell Plain", "The Fissure"],
["Jee Enir", "Walled Stronghold", "Island of Broken Dreams", "Forest of the Plume"],
["Lee Sefan", "Forgotten Sanctuary", "Bamboo Village", "Rook's Valley"],
["Loo Kohan", "The Fissure", "Forgotten Sanctuary", "Bamboo Village"],
["Lor Wenil", "Farewell Plain", "The Fissure", "Forgotten Sanctuary"],
["Ol Ninze", "Forest of the Plume", "Windy Tomb Canyon", "Dawnglory"],
["Wan Lanch", "Windy Tomb Canyon", "Dawnglory", "Farewell Plain"],
["Wong Zehow", "Island of Broken Dreams", "Forest of the Plume", "Windy Tomb Canyon"],
["Xi Chenko", "Bamboo Village", "Rook's Valley", "Walled Stronghold"]];

var sortSelect = function(sel) {
	var opts_list = sel.find('option');
	opts_list.sort(function(a, b) { return $(a).text() > $(b).text() ? 1 : -1; });
	sel.empty().append(opts_list);
};

var init = function(side, npclist) {
	var npcSelect = $("#"+side+" .npcName");
	var locationSelect = $("#"+side+" .location");
	var result = $("#"+side+" .result");
	for (var i = 0; i < npclist.length; i++)
		npcSelect.append($("<option value=\""+(i)+"\">"+npclist[i][0]+"</option>"));
	sortSelect(npcSelect);
	npcSelect.prepend('<option value="-1" selected>Select an NPC</option>');
	npcSelect.change(function(){
		var val = $(this).val();
		if (val < 0 || val >= npclist.length) return;
		$("option[value=-1]", $(this)).remove();
		locationSelect.empty()
		for(var i = 1; i < npclist[val].length; i++) 
			locationSelect.append($("<option value=\""+(i)+"\">"+npclist[val][i]+"</option>"));
		sortSelect(locationSelect);
		locationSelect.prepend('<option value="-1" selected>Select a location</option>');
	});
	locationSelect.change(function(){
		var val = $(this).val();
		if (val == -1) return;
		$("option[value=-1]", $(this)).remove();
		result.empty();
		for(var i = 0; i < npclist.length; i++) {
			result.append($("<div class='namelabel'>"+npclist[i][0]+"</div> is in <div class='label'>"+npclist[i][val]+"</div><br>"));
		}
		var button = $(".submit", $(this).closest(".container"));
		button.show();
		if ($(".message", $(this).closest(".container")).text() == "")
			button.prop('disabled', false);
	});
}; 

var makeSightingWidget = function(record) {
	var npclist = [npcs, otherNpcs][record.type];
	if (record.npc < 0 || record.npc >= npclist.length || record.loc < 1 || record.loc >= npclist[0].length) 
		return;
	var date = new Date(record.time*1000);
	var identicon = '<div style="display: inline-block; width:20px; height:20px; background-image: url(\'http://vanillicon.com/'+record.id+'_50.png\'); background-size: cover"></div> saw ';
	var typeName = record.type ? " <span style='color: #BFB'>walking</span> in " : " <span style='color: #FBB'>standing</span> in ";
	var sighting = $("<div class='sighting'><span class='time'>"+date.toLocaleString()+"</span>: </div>").append(identicon);
	var link = $("<span class='link'>"+npclist[record.npc][0]+typeName+npclist[record.npc][record.loc]+" (#"+record.loc+")</span>");
	link.click(function(){
		var type = record.type == "1" ? "#walking" : "#normal";
		$(".npcName", type).val(record.npc).change();
		$(".location", type).val(record.loc).change();
		$(".submit", type).prop('disabled', true);
	});
	sighting.append(link);
	return sighting;
};

var autoPickSighting = function(records) {
	var server = localStorage.getItem('server');
	if (!server) return;
	var counts = [{}, {}]
	for (var i = 0; i < records.length; i++) {
		if (isCurrentDay(records[i].time, server)) {
			counts[records[i].type][records[i].loc] = (counts[records[i].type][records[i].loc] || 0) + 1;
		}
	}
	var keys = [Object.keys(counts[0]), Object.keys(counts[1])];
	for (var i = 0; i < keys.length; i++) {
		var maxValue = 0;
		var maxLoc = 0;
		for (var j = 0; j < keys[i].length; j++) {
			if (counts[i][keys[i][j]] > maxValue) {
				maxValue = counts[i][keys[i][j]];
				maxLoc = keys[i][j];
			}
		}
		if (maxLoc > 0 && maxValue >= 2) {
			var type = ["#normal", "#walking"][i];
			$(".npcName", type).val(0).change();
			$(".location", type).val(maxLoc).change();
			$(".submit", type).prop('disabled', true);
		}
	}
};

var setSightings = function(data) {
	console.log(data);
	$(".sightings .result").empty();
	for (var i = 0; i < data.records.length; i++) {
		$(".sightings .result").prepend(makeSightingWidget(data.records[i]));
	}
	autoPickSighting(data.records);
};

var isCurrentDay = function(utc, server) {
	var locations = {
		"etherblade":	"US/Pacific",
		"twilight":	"US/Pacific",
		"tideswell":	"US/Eastern",
		"dawnglory": "Europe/Paris"	
	};

	var location = locations[server];
	var daystart = moment.utc().tz(location).startOf('day');
	return daystart.diff(moment.utc(utc*1000)) < 0;
};

var initSightings = function() {
	$(".sightings .server").change(function(){
		var server = $(this).val();
		if (server == "-1") return;
		$(".sightings .server option[value=-1]").remove();
		localStorage.setItem('server', server);
		$.ajax({url: "getrecord.php?q="+server, dataType: "json"}).done(setSightings);
	});
	
	$(".submit").click(function(){
		var message = $('.message', $(this).closest('.container'));
		var server = $(".server").val();
		var type = $(this).closest("#walking").length;
		var button = $(this);
		
		var captchaSuccess = function(response){
			token = response;
			button.click();
		};
		
		if (token == ''){
			if ($("#captcha"+type).length == 0) {
				var capctchaDiv = $("<div id='captcha"+type+"' 'class='recaptcha'></div>")
				$(this).closest('.container').append(capctchaDiv);
				grecaptcha.render(capctchaDiv[0], {
					'sitekey' : '6LfULR4TAAAAAKbR_S0t-H025tlQFnX6GFZC9t9L',
					'callback' : captchaSuccess,
					'theme' : 'dark'
				});
			}
			return;
		}
		//if (grecaptcha.getResponse('captcha'+type) == '')
		//	return;
		//token = grecaptcha.getResponse('captcha'+type);

		var npc = $(".npcName", $(this).closest(".container")).val();
		var loc = $(".location", $(this).closest(".container")).val();
		if (server == -1 || npc == -1 || loc == -1) {
			return;
		}
		$(this).prop('disabled', true);

		$.post("http://aster.ohmydays.net/pw/elysiumlocations/record.php", {
			q: server,
			type: type,
			name: npc,
			loc: loc,
			token: token
		}).done(function(result){
			message.text("Thanks!").toggle;
			$(".sightings .server").change();
			token = '';
			$(".recaptcha").remove();
		});
	}).hide();
};

function load() {
	var server = localStorage.getItem('server');
	if (server) {
		$(".sightings .server").val(server).change();
	}
};

var onloadCallback = function() {};

  
$(document).ready(function(){
	init('normal', npcs);
	init('walking', otherNpcs);
	initSightings();
	load();
});